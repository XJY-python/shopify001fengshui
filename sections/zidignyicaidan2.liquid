{% comment %}
  è‡ªå®šä¹‰èœå•ç³»ç»Ÿ - å¢å¼ºç‰ˆ
  å·¦ä¾§ï¼šä¸‹æ‹‰èœå•æŒ‰é’®ï¼Œå³ä¾§ï¼šäº§å“ä¿¡æ¯å±•ç¤º
  è¯´æ˜ï¼šæ”¯æŒè‡ªå®šä¹‰å®½åº¦ï¼Œä¸‹æ‹‰æ–¹å¼å±•ç°ç³»åˆ—åˆ†ç±»ï¼Œå³ä¾§å±•ç¤ºäº§å“ä¿¡æ¯
{% endcomment %}

{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'section-related-products.css' | asset_url | stylesheet_tag }}
{{ 'font-awesome.css' | asset_url | stylesheet_tag }}

{% schema %}
{
  "name": "è‡ªå®šä¹‰èœå•ç³»ç»Ÿ",
  "class": "custom-menu-section",
  "settings": [
    {
      "type": "header",
      "content": "å¸ƒå±€è®¾ç½®"
    },
    {
      "type": "range",
      "id": "menu_width",
      "label": "èœå•é¢æ¿å®½åº¦",
      "min": 20,
      "max": 50,
      "step": 5,
      "default": 30,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_width",
      "label": "äº§å“é¢æ¿å®½åº¦",
      "min": 50,
      "max": 80,
      "step": 5,
      "default": 70,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "æ¡Œé¢ç«¯æ¯è¡Œäº§å“æ•°é‡",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "unit": "ä¸ª"
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "label": "ç§»åŠ¨ç«¯æ¯è¡Œäº§å“æ•°é‡",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2,
      "unit": "ä¸ª"
    },
    {
      "type": "range",
      "id": "rows_desktop",
      "label": "æ¡Œé¢ç«¯æ˜¾ç¤ºè¡Œæ•°",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 3,
      "unit": "è¡Œ"
    },
    {
      "type": "range",
      "id": "rows_mobile",
      "label": "ç§»åŠ¨ç«¯æ˜¾ç¤ºè¡Œæ•°",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 2,
      "unit": "è¡Œ"
    },
    {
      "type": "header",
      "content": "æ ·å¼è®¾ç½®"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "ä¸»è‰²è°ƒ",
      "default": "#007bff"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "è¾¹æ¡†é¢œè‰²",
      "default": "#e1e1e1"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "èƒŒæ™¯é¢œè‰²",
      "default": "#f8f8f8"
    },
    {
      "type": "header",
      "content": "è¾¹è·è®¾ç½®"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "ä¸Šè¾¹è·",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "ä¸‹è¾¹è·",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "menu_category",
      "name": "èœå•åˆ†ç±»",
      "settings": [
        {
          "type": "text",
          "id": "category_title",
          "label": "åˆ†ç±»æ ‡é¢˜",
          "default": "äº§å“åˆ†ç±»"
        },
        {
          "type": "text",
          "id": "category_description",
          "label": "åˆ†ç±»æè¿°",
          "default": "åˆ†ç±»æè¿°å†…å®¹"
        },
        {
          "type": "header",
          "content": "èœå•å›¾ç‰‡è®¾ç½®"
        },
        {
          "type": "image_picker",
          "id": "category_image",
          "label": "èœå•å›¾ç‰‡"
        },
        {
          "type": "range",
          "id": "image_width",
          "label": "å›¾ç‰‡å®½åº¦",
          "min": 20,
          "max": 100,
          "step": 5,
          "default": 60,
          "unit": "px"
        },
        {
          "type": "range",
          "id": "image_height",
          "label": "å›¾ç‰‡é«˜åº¦",
          "min": 20,
          "max": 100,
          "step": 5,
          "default": 60,
          "unit": "px"
        },
        {
          "type": "header",
          "content": "äº§å“ç³»åˆ—é…ç½®"
        },
        {
          "type": "collection_list",
          "id": "linked_collections",
          "label": "å…³è”äº§å“ç³»åˆ—",
          "limit": 10
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "è‡ªå®šä¹‰èœå•",
      "category": "å¯¼èˆª",
      "blocks": [
        {
          "type": "menu_category",
          "settings": {
            "category_title": "çƒ­é—¨å•†å“",
            "category_description": "æŸ¥çœ‹çƒ­é—¨å•†å“"
          }
        },
        {
          "type": "menu_category",
          "settings": {
            "category_title": "æ–°å“ä¸Šå¸‚",
            "category_description": "æœ€æ–°ä¸Šæ¶å•†å“"
          }
        }
      ]
    }
  ]
}
{% endschema %}

{%- style -%}
  .custom-menu-section-{{ section.id }} {
    display: flex;
    gap: 20px;
    padding: {{ section.settings.padding_top }}px 20px {{ section.settings.padding_bottom }}px;
    min-height: 500px;
    background-color: {{ section.settings.background_color }};
    max-width: 1200px;
    margin: 0 auto;
  }

  .menu-panel-{{ section.id }} {
    width: {{ section.settings.menu_width }}%;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .products-panel-{{ section.id }} {
    width: {{ section.settings.product_width }}%;
    padding: 20px;
    border: 1px solid {{ section.settings.border_color }};
    border-radius: 12px;
    background: white;
    min-height: 400px;
  }

  /* ä¸‹æ‹‰èœå•æ ·å¼ */
  .menu-category-{{ section.id }} {
    position: relative;
    background: white;
    border: 1px solid {{ section.settings.border_color }};
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .menu-category-{{ section.id }}:hover {
    background-color: #f8f8f8;
    border-color: #d0d0d0;
  }

  .menu-category-{{ section.id }}.active {
    background-color: #f0f8ff;
    border-color: {{ section.settings.primary_color }};
  }

  .category-header-{{ section.id }} {
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    gap: 10px;
  }

  .category-header-content {
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-direction: row;
  }
  
  .category-image-{{ section.id }} {
    width: {{ block.settings.image_width }}px;
    height: {{ block.settings.image_height }}px;
    object-fit: cover;
    border-radius: 6px;
    flex-shrink: 0;
    order: -1; /* ç¡®ä¿å›¾ç‰‡æ˜¾ç¤ºåœ¨æœ€å·¦ä¾§ */
  }

  .category-text-content {
    flex: 1;
    min-width: 0;
  }

  .category-header-{{ section.id }} h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
    line-height: 1.3;
    text-align: left;
  }

  .category-header-{{ section.id }} p {
    margin: 4px 0 0 0;
    font-size: 14px;
    color: #666;
    line-height: 1.4;
    display: block;
    text-align: left;
  }

  .dropdown-icon-container {
    flex-shrink: 0;
    margin-top: 4px;
  }

  .dropdown-icon-{{ section.id }} {
    transition: transform 0.3s ease;
    font-size: 12px;
    color: #666;
    display: block;
  }

  .dropdown-icon-{{ section.id }} {
    transition: transform 0.3s ease;
  }

  .menu-category-{{ section.id }}.active .dropdown-icon-{{ section.id }} {
    transform: rotate(180deg);
  }

  .dropdown-content-{{ section.id }} {
    display: none;
    padding: 15px;
    border-top: 1px solid {{ section.settings.border_color }};
    background: white;
  }

  .menu-category-{{ section.id }}.active .dropdown-content-{{ section.id }} {
    display: block;
  }

  .collection-list-{{ section.id }} {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .collection-item-{{ section.id }} {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: color 0.2s ease;
    text-align: center;
  }

  .collection-item-{{ section.id }}:hover {
    color: {{ section.settings.primary_color }};
  }

  .collection-item-{{ section.id }}:last-child {
    border-bottom: none;
  }

  /* äº§å“å±•ç¤ºæ ·å¼ */
  .product-grid-{{ section.id }} {
    display: grid;
    grid-template-columns: repeat({{ section.settings.columns_desktop }}, minmax(0, 1fr));
    gap: 20px;
  }
  
  .product-card-{{ section.id }} {
    border: 1px solid #f0f0f0;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
    background: white;
    list-style: none;
    margin: 0;
  }

  .product-card-{{ section.id }}:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: {{ section.settings.primary_color }};
  }

  .product-image-{{ section.id }} {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 12px;
  }

  .product-title-{{ section.id }} {
    margin: 0 0 8px 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }

  .product-vendor-{{ section.id }} {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: #666;
  }

  .product-price-{{ section.id }} {
    margin: 0;
    font-size: 18px;
    font-weight: bold;
    color: {{ section.settings.primary_color }};
  }

  .loading-{{ section.id }} {
    text-align: center;
    padding: 60px 20px;
    color: #999;
  }

  .empty-state-{{ section.id }} {
    text-align: center;
    padding: 60px 20px;
    color: #999;
  }

  .empty-state-{{ section.id }} h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
    color: #666;
  }

  .empty-state-{{ section.id }} p {
    margin: 0;
    font-size: 14px;
  }

  /* å“åº”å¼è®¾è®¡ - ä½¿ç”¨ä¸»é¢˜æ ‡å‡†æ–­ç‚¹ */
  @media screen and (max-width: 749px) {
    .custom-menu-section-{{ section.id }} {
      flex-direction: column;
      padding: 20px 15px;
    }

    .menu-panel-{{ section.id }},
    .products-panel-{{ section.id }} {
      width: 100% !important;
    }

    .menu-panel-{{ section.id }} {
      order: 1; /* èœå•åœ¨ä¸Šé¢ */
      margin-bottom: 20px;
    }

    .products-panel-{{ section.id }} {
      order: 2; /* äº§å“åœ¨ä¸‹é¢ */
      min-height: 300px;
    }

    .product-grid-{{ section.id }} {
      grid-template-columns: repeat({{ section.settings.columns_mobile }}, minmax(0, 1fr));
      gap: 15px;
    }

    .product-image-{{ section.id }} {
      height: 150px;
    }

    .product-title-{{ section.id }} {
      font-size: 14px;
    }

    .product-price-{{ section.id }} {
      font-size: 16px;
    }

    .category-header-{{ section.id }} {
      padding: 12px;
    }

    .dropdown-content-{{ section.id }} {
      padding: 12px;
    }

    /* ç§»åŠ¨ç«¯èœå•é¡¹ç‚¹å‡»è·³è½¬ */
    .collection-item-{{ section.id }} {
      cursor: pointer;
      text-align: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
      transition: all 0.2s ease;
    }

    .collection-item-{{ section.id }}:hover,
    .collection-item-{{ section.id }}:active {
      background-color: #f8f8f8;
      color: {{ section.settings.primary_color }};
    }
  }

  /* ç½®é¡¶æŒ‰é’®æ ·å¼ - åªåœ¨ç§»åŠ¨ç«¯æ˜¾ç¤º */
  .sticky-header-{{ section.id }} {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: white;
    padding: 15px;
    border-bottom: 2px solid {{ section.settings.primary_color }};
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: none; /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: space-between;
  }

  .sticky-header-{{ section.id }} .sticky-title {
    font-size: 18px;
    font-weight: bold;
    color: {{ section.settings.primary_color }};
    margin: 0;
  }

  .sticky-header-{{ section.id }} .back-button {
    background: {{ section.settings.primary_color }};
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
  }

  /* æ¡Œé¢ç«¯ç½®é¡¶æŒ‰é’®å®Œå…¨éšè— - ä½¿ç”¨ä¸»é¢˜æ ‡å‡†æ–­ç‚¹ */
  @media screen and (min-width: 750px) {
    .sticky-header-{{ section.id }} {
      width: 1px !important;
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }
  }
{%- endstyle -%}

<div class="custom-menu-section-{{ section.id }}">
  <!-- ç½®é¡¶æŒ‰é’® - ç§»åŠ¨ç«¯ä½¿ç”¨ -->
  <div class="sticky-header-{{ section.id }}" id="sticky-header-{{ section.id }}">
    <h3 class="sticky-title"></h3>
  <button class="back-button" onclick="backToMenuList()">Back to List</button>
  </div>

  <!-- å·¦ä¾§èœå•é¢æ¿ -->
  <div class="menu-panel-{{ section.id }}">
    {% for block in section.blocks %}
      {% if block.type == 'menu_category' %}
        <div class="menu-category-{{ section.id }}" data-category="{{ block.id }}">
          <div class="category-header-{{ section.id }}">
            <div class="category-header-content">
              {% if block.settings.category_image %}
                <img class="category-image-{{ section.id }}" 
                     src="{{ block.settings.category_image | img_url: 'medium' }}" 
                     alt="{{ block.settings.category_title }}"
                     width="{{ block.settings.image_width }}"
                     height="{{ block.settings.image_height }}">
              {% endif %}
              <div class="category-text-content">
                <h3>{{ block.settings.category_title }}</h3>
                <p>{{ block.settings.category_description }}</p>
              </div>
            </div>
            <div class="dropdown-icon-container">
              <span class="dropdown-icon-{{ section.id }}">â–¼</span>
            </div>
          </div>
          
          <div class="dropdown-content-{{ section.id }}">
            {% if block.settings.linked_collections %}
              <ul class="collection-list-{{ section.id }}">
                {% for collection in block.settings.linked_collections %}
                  <li class="collection-item-{{ section.id }}" 
                      data-collection-id="{{ collection.id }}"
                      data-collection-handle="{{ collection.handle }}"
                      data-category-title="{{ block.settings.category_title }}">
                    {{ collection.title }}
                  </li>
                {% endfor %}
              </ul>
    {% else %}
      <p class="empty-state-{{ section.id }}">No collections linked</p>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endfor %}
    
    {% if section.blocks.size == 0 %}
      <div class="empty-state-{{ section.id }}">
        <h3>Please add menu categories</h3>
        <p>Click "Add content" in the theme editor to create menu categories</p>
      </div>
    {% endif %}
  </div>
  
  <!-- å³ä¾§äº§å“å±•ç¤ºé¢æ¿ -->
  <div class="products-panel-{{ section.id }}">
    <div class="empty-state-{{ section.id }}">
      <h3>Please click on the left menu to view products</h3>
      <p>Click menu categories to show all products, click specific collections to show collection products</p>
    </div>
  </div>
</div>

<script>
// æ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬ - å‡å°‘DOMæ“ä½œï¼Œä¼˜åŒ–AJAXè¯·æ±‚ï¼Œç®€åŒ–äº§å“æ˜¾ç¤ºé€»è¾‘
document.addEventListener('DOMContentLoaded', function() {
  const sectionId = '{{ section.id }}';
  const productsPanel = document.querySelector(`.products-panel-${sectionId}`);
  let allProductsData = null;
  let isProcessing = false;
  let activeRequest = null;

  // ç¼“å­˜DOMå…ƒç´ å¼•ç”¨
  const cachedElements = {
    stickyHeader: document.getElementById(`sticky-header-${sectionId}`),
    menuCategories: document.querySelectorAll(`.menu-category-${sectionId}`),
    collectionItems: document.querySelectorAll(`.collection-item-${sectionId}`)
  };

  // å–æ¶ˆå½“å‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
  function cancelActiveRequest() {
    if (activeRequest) {
      activeRequest.abort();
      activeRequest = null;
    }
  }

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  function showLoadingState(message = 'Loading products...') {
    productsPanel.innerHTML = `
      <div class="loading-${sectionId}">
        <p>${message}</p>
      </div>
    `;
  }

  // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
  function showErrorState() {
    productsPanel.innerHTML = `
      <div class="empty-state-${sectionId}">
        <div style="font-size: 24px; margin-bottom: 10px;">âŒ</div>
        <h3>Load Failed</h3>
        <p>Unable to load product data, please try again later</p>
      </div>
    `;
  }

  // æ˜¾ç¤ºç©ºçŠ¶æ€
  function showEmptyState() {
    productsPanel.innerHTML = `
      <div class="empty-state-${sectionId}">
        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“¦</div>
        <h3>No Products</h3>
        <p>Please configure product collections first</p>
      </div>
    `;
  }

  // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨äº‹ä»¶å§”æ‰˜
  function setupEventDelegation() {
    const menuPanel = document.querySelector(`.menu-panel-${sectionId}`);
    if (!menuPanel) return;

    menuPanel.addEventListener('click', function(e) {
      if (isProcessing) return;
      
      const target = e.target;
      const category = target.closest(`.menu-category-${sectionId}`);
      const collectionItem = target.closest(`.collection-item-${sectionId}`);
      
      if (category) {
        e.preventDefault();
        handleCategoryClick(category);
      } else if (collectionItem) {
        e.preventDefault();
        e.stopPropagation();
        handleCollectionClick(collectionItem);
      }
    });
  }

  // å¤„ç†åˆ†ç±»ç‚¹å‡»
  function handleCategoryClick(category) {
    cancelActiveRequest();
    isProcessing = true;
    
    // æ›´æ–°æ¿€æ´»çŠ¶æ€
    cachedElements.menuCategories.forEach(cat => cat.classList.remove('active'));
    category.classList.add('active');
    
    // ç§»é™¤æ‰€æœ‰ç³»åˆ—é¡¹çš„æ¿€æ´»çŠ¶æ€
    cachedElements.collectionItems.forEach(item => item.classList.remove('active'));
    
    loadAllProducts();
  }

  // å¤„ç†ç³»åˆ—ç‚¹å‡»
  function handleCollectionClick(collectionItem) {
    cancelActiveRequest();
    isProcessing = true;
    
    const collectionHandle = collectionItem.getAttribute('data-collection-handle');
    const categoryTitle = collectionItem.getAttribute('data-category-title');
    
    if (!collectionHandle) {
      showEmptyState();
      isProcessing = false;
      return;
    }

    // æ›´æ–°æ¿€æ´»çŠ¶æ€
    cachedElements.collectionItems.forEach(item => item.classList.remove('active'));
    collectionItem.classList.add('active');
    
    // è®¾ç½®çˆ¶åˆ†ç±»ä¸ºæ¿€æ´»çŠ¶æ€
    const parentCategory = collectionItem.closest(`.menu-category-${sectionId}`);
    if (parentCategory) {
      cachedElements.menuCategories.forEach(cat => cat.classList.remove('active'));
      parentCategory.classList.add('active');
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯ç§»åŠ¨è®¾å¤‡
    const isMobile = window.innerWidth <= 749;
    
    if (isMobile) {
      // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºç½®é¡¶æŒ‰é’®
      const stickyTitle = cachedElements.stickyHeader.querySelector('.sticky-title');
      stickyTitle.textContent = categoryTitle || 'Product List';
      cachedElements.stickyHeader.style.display = 'flex';
      
      // æ»šåŠ¨åˆ°äº§å“é¢æ¿
      productsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    loadSingleCollection(collectionHandle);
  }

  // åŠ è½½æ‰€æœ‰ç³»åˆ—çš„äº§å“ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
  function loadAllProducts() {
    if (allProductsData) {
      displayProducts(allProductsData);
      isProcessing = false;
      return;
    }

    showLoadingState('Loading all products...');

    // æ”¶é›†æ‰€æœ‰ç³»åˆ—å¥æŸ„
    const collectionHandles = [];
    cachedElements.collectionItems.forEach(item => {
      const handle = item.getAttribute('data-collection-handle');
      if (handle) collectionHandles.push(handle);
    });

    if (collectionHandles.length === 0) {
      showEmptyState();
      isProcessing = false;
      return;
    }

    // é™åˆ¶å¹¶å‘è¯·æ±‚æ•°é‡ï¼ˆæœ€å¤š3ä¸ªï¼‰
    const MAX_CONCURRENT_REQUESTS = 3;
    const results = new Array(collectionHandles.length).fill('');
    let completed = 0;

    function processBatch(startIndex) {
      const batch = collectionHandles.slice(startIndex, startIndex + MAX_CONCURRENT_REQUESTS);
      const promises = batch.map((handle, index) => 
        fetch(`/collections/${handle}`)
          .then(response => response.ok ? response.text() : '')
          .then(html => {
            results[startIndex + index] = html;
            completed++;
            
            // æ›´æ–°è¿›åº¦
            if (completed % 2 === 0) { // æ¯å®Œæˆ2ä¸ªè¯·æ±‚æ›´æ–°ä¸€æ¬¡è¿›åº¦
              const progress = Math.round((completed / collectionHandles.length) * 100);
              showLoadingState(`Loading all products... ${progress}%`);
            }
          })
          .catch(() => '')
      );

      return Promise.all(promises);
    }

    // åˆ†æ‰¹å¤„ç†è¯·æ±‚
    (async function() {
      try {
        for (let i = 0; i < collectionHandles.length; i += MAX_CONCURRENT_REQUESTS) {
          await processBatch(i);
        }
        
        const combinedHtml = results.filter(html => html.trim()).join('');
        allProductsData = combinedHtml;
        displayProducts(combinedHtml);
        isProcessing = false;
      } catch (error) {
        console.error('åŠ è½½æ‰€æœ‰äº§å“é”™è¯¯:', error);
        showErrorState();
        isProcessing = false;
      }
    })();
  }

  // åŠ è½½å•ä¸ªç³»åˆ—çš„äº§å“
  function loadSingleCollection(collectionHandle) {
    showLoadingState('Loading collection products...');

    // ä½¿ç”¨AbortControlleræ§åˆ¶è¯·æ±‚
    const controller = new AbortController();
    activeRequest = controller;

    // ç›´æ¥åŠ è½½ç³»åˆ—é¡µé¢ï¼Œä¸ä½¿ç”¨ajax-productsè§†å›¾å‚æ•°
    // è¿™æ ·å¯ä»¥ç¡®ä¿åŠ è½½ç‰¹å®šç³»åˆ—çš„æ­£ç¡®äº§å“
    fetch(`/collections/${collectionHandle}`, {
      signal: controller.signal
    })
      .then(response => {
        if (!response.ok) throw new Error('Network response error');
        return response.text();
      })
      .then(html => {
        displayProducts(html);
        isProcessing = false;
        activeRequest = null;
      })
      .catch(error => {
        if (error.name === 'AbortError') {
          console.log('è¯·æ±‚è¢«å–æ¶ˆ');
        } else {
          console.error('åŠ è½½ç³»åˆ—äº§å“é”™è¯¯:', error);
          showErrorState();
        }
        isProcessing = false;
        activeRequest = null;
      });
  }

  // è¯¦ç»†çš„äº§å“æ˜¾ç¤ºé€»è¾‘ - ä¿®å¤é‡å¤æ˜¾ç¤ºé—®é¢˜
  function displayProducts(html) {
    if (!html || typeof html !== 'string' || html.trim() === '') {
      showEmptyState();
      return;
    }

    // åˆ›å»ºä¸´æ—¶å®¹å™¨æ¥è§£æHTML
    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = html;
    
    // è°ƒè¯•ï¼šè®°å½•HTMLå†…å®¹ä»¥æŸ¥çœ‹å®é™…è¿”å›äº†ä»€ä¹ˆ
    console.log('Received HTML content length:', html.length);
    console.log('HTML contains collection title:', html.includes('collection-title') || html.includes('collection__title'));
    
    // è·å–äº§å“ç½‘æ ¼å…ƒç´  - ä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨
    const productGrid = tempContainer.querySelector('.grid.product-grid, .grid--2-col, .grid--3-col, .grid--4-col, [data-section-type="collection-template"] .grid, .collection .grid');
    
    if (!productGrid) {
      console.log('No product grid found in HTML. Available elements:');
      const allElements = tempContainer.querySelectorAll('*');
      allElements.forEach(el => {
        if (el.className && el.className.includes('grid')) {
          console.log('Found grid element:', el.className);
        }
      });
      showEmptyState();
      return;
    }

    console.log('Found product grid with class:', productGrid.className);
    
    // åˆ›å»ºæ–°çš„äº§å“ç½‘æ ¼å®¹å™¨
    const newProductGrid = document.createElement('div');
    newProductGrid.className = 'product-grid-{{ section.id }}';
    
    // ä½¿ç”¨æ›´ç²¾ç¡®çš„äº§å“é€‰æ‹©å™¨ - åªé€‰æ‹©çœŸæ­£çš„äº§å“å¡ç‰‡
    // ä¼˜å…ˆé€‰æ‹©å…·æœ‰äº§å“æ•°æ®å±æ€§çš„å…ƒç´ ï¼Œé¿å…é€‰æ‹©é‡å¤çš„å¡ç‰‡
    let productCards = productGrid.querySelectorAll('[data-product-id], [data-product-handle], [data-product-url]');
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–å¸¸è§çš„é€‰æ‹©å™¨
    if (productCards.length === 0) {
      productCards = productGrid.querySelectorAll('.grid__item:not(.grid__item--no-result), .card:not(.card--no-result), .product-card, .card-wrapper');
    }
    
    console.log('Found', productCards.length, 'potential product cards');
    
    if (productCards.length === 0) {
      showEmptyState();
      return;
    }

    // ä½¿ç”¨Setæ¥è·Ÿè¸ªå·²å¤„ç†çš„äº§å“ï¼Œé¿å…é‡å¤
    const processedProducts = new Set();
    const uniqueProductCards = [];
    
    // é¦–å…ˆè¿‡æ»¤å‡ºå”¯ä¸€çš„äº§å“å¡ç‰‡
    productCards.forEach((card) => {
      // è·å–äº§å“çš„å”¯ä¸€æ ‡è¯† - ä¼˜å…ˆä½¿ç”¨data-product-handle
      const productHandle = card.getAttribute('data-product-handle') || 
                           card.querySelector('[data-product-handle]')?.getAttribute('data-product-handle');
      const productId = card.getAttribute('data-product-id') || 
                        card.querySelector('[data-product-id]')?.getAttribute('data-product-id');
      const productUrl = card.querySelector('a[href*="/products/"]')?.href;
      
      // ä½¿ç”¨äº§å“handleä½œä¸ºä¸»è¦å”¯ä¸€æ ‡è¯†
      const uniqueId = productHandle || productId || productUrl;
      
      if (!uniqueId) {
        console.log('Skipping card without unique identifier:', card);
        return;
      }
      
      // å¦‚æœè¿™ä¸ªäº§å“å·²ç»å¤„ç†è¿‡ï¼Œè·³è¿‡
      if (processedProducts.has(uniqueId)) {
        console.log('Skipping duplicate product:', uniqueId);
        return;
      }
      
      processedProducts.add(uniqueId);
      uniqueProductCards.push(card);
    });

    console.log('After deduplication:', uniqueProductCards.length, 'unique products');
    
    // å¤„ç†æ¯ä¸ªå”¯ä¸€çš„äº§å“å¡ç‰‡
    uniqueProductCards.forEach((card, index) => {
      const newCard = document.createElement('div');
      newCard.className = 'product-card-{{ section.id }}';
      
      // å¤åˆ¶åŸå§‹å¡ç‰‡å†…å®¹
      newCard.innerHTML = card.innerHTML;
      
      // ç¡®ä¿å›¾ç‰‡æ­£ç¡®æ˜¾ç¤º
      const images = newCard.querySelectorAll('img');
      images.forEach(img => {
        if (img.src && !img.src.includes('http')) {
          // ä¿®å¤ç›¸å¯¹è·¯å¾„å›¾ç‰‡
          img.src = img.src.replace(/^\/\//, 'https://');
        }
        img.style.width = '100%';
        img.style.height = '200px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '6px';
        img.style.marginBottom = '12px';
      });
      
      // ç¡®ä¿æ ‡é¢˜æ ·å¼
      const title = newCard.querySelector('.card__heading, .card-information__text, .product-title, [data-product-title]');
      if (title) {
        title.className = 'product-title-{{ section.id }}';
        title.style.margin = '0 0 8px 0';
        title.style.fontSize = '16px';
        title.style.fontWeight = '600';
        title.style.color = '#333';
      }
      
      // ç¡®ä¿ä»·æ ¼æ ·å¼
      const price = newCard.querySelector('.price, .price-item, .product-price, [data-product-price]');
      if (price) {
        price.className = 'product-price-{{ section.id }}';
        price.style.margin = '0';
        price.style.fontSize = '18px';
        price.style.fontWeight = 'bold';
        price.style.color = '{{ section.settings.primary_color }}';
      }
      
      // æ·»åŠ åŠ¨ç”»å»¶è¿Ÿ
      newCard.style.animationDelay = `${index * 0.05}s`;
      
      newProductGrid.appendChild(newCard);
    });

    console.log('Displaying', uniqueProductCards.length, 'unique products');
    
    // ä½¿ç”¨requestAnimationFrameæé«˜æ€§èƒ½
    requestAnimationFrame(() => {
      productsPanel.innerHTML = '';
      productsPanel.appendChild(newProductGrid);
    });
  }

  // åˆå§‹åŒ–
  function init() {
    setupEventDelegation();
    
    // é»˜è®¤åŠ è½½æ‰€æœ‰äº§å“ï¼ˆå»¶è¿Ÿæ‰§è¡Œä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼‰
    setTimeout(() => {
      if (!isProcessing) {
        loadAllProducts();
        // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªèœå•åˆ†ç±»
        if (cachedElements.menuCategories.length > 0) {
          cachedElements.menuCategories[0].classList.add('active');
        }
      }
    }, 100);
  }

  // å¯åŠ¨åˆå§‹åŒ–
  init();
});

// è¿”å›èœå•åˆ—è¡¨å‡½æ•°
function backToMenuList() {
  const stickyHeader = document.getElementById(`sticky-header-{{ section.id }}`);
  if (stickyHeader) {
    stickyHeader.style.display = 'none';
  }
  
  // æ»šåŠ¨å›é¡¶éƒ¨
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
}

// é¢„åŠ è½½CSSåŠ¨ç”»ï¼ˆé¿å…åŠ¨æ€åˆ›å»ºstyleæ ‡ç­¾ï¼‰
if (!document.getElementById('custom-menu-animations')) {
  const style = document.createElement('style');
  style.id = 'custom-menu-animations';
  style.textContent = `
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .product-card-{{ section.id }} {
      animation: fadeIn 0.3s ease forwards;
    }
  `;
  document.head.appendChild(style);
}
</script>

{% comment %}
  ä½¿ç”¨è¯´æ˜:
  1. å°†æ­¤æ–‡ä»¶ä¿å­˜ä¸º sections/custom-menu.liquid
  2. åœ¨ä¸»é¢˜ç¼–è¾‘å™¨ä¸­æ·»åŠ æ­¤section
  3. ç‚¹å‡»"æ·»åŠ å†…å®¹"åˆ›å»ºèœå•æŒ‰é’®
  4. ä¸ºæ¯ä¸ªæŒ‰é’®é…ç½®æ ‡é¢˜ã€æè¿°å’Œå…³è”çš„ç³»åˆ—
  5. ä¿å­˜åå³å¯ä½¿ç”¨
{% endcomment %}
