{% comment %}
  è‡ªå®šä¹‰èœå•ç³»ç»Ÿ - å¢å¼ºç‰ˆ
  å·¦ä¾§ï¼šä¸‹æ‹‰èœå•æŒ‰é’®ï¼Œå³ä¾§ï¼šäº§å“ä¿¡æ¯å±•ç¤º
  è¯´æ˜ï¼šæ”¯æŒè‡ªå®šä¹‰å®½åº¦ï¼Œä¸‹æ‹‰æ–¹å¼å±•ç°ç³»åˆ—åˆ†ç±»ï¼Œå³ä¾§å±•ç¤ºäº§å“ä¿¡æ¯
{% endcomment %}

{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'section-related-products.css' | asset_url | stylesheet_tag }}
{{ 'font-awesome.css' | asset_url | stylesheet_tag }}

{% schema %}
{
  "name": "è‡ªå®šä¹‰èœå•ç³»ç»Ÿ",
  "class": "custom-menu-section",
  "settings": [
    {
      "type": "header",
      "content": "å¸ƒå±€è®¾ç½®"
    },
    {
      "type": "range",
      "id": "menu_width",
      "label": "èœå•é¢æ¿å®½åº¦",
      "min": 20,
      "max": 50,
      "step": 5,
      "default": 30,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_width",
      "label": "äº§å“é¢æ¿å®½åº¦",
      "min": 50,
      "max": 80,
      "step": 5,
      "default": 70,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "æ¡Œé¢ç«¯æ¯è¡Œäº§å“æ•°é‡",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "unit": "ä¸ª"
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "label": "ç§»åŠ¨ç«¯æ¯è¡Œäº§å“æ•°é‡",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2,
      "unit": "ä¸ª"
    },
    {
      "type": "range",
      "id": "rows_desktop",
      "label": "æ¡Œé¢ç«¯æ˜¾ç¤ºè¡Œæ•°",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 3,
      "unit": "è¡Œ"
    },
    {
      "type": "range",
      "id": "rows_mobile",
      "label": "ç§»åŠ¨ç«¯æ˜¾ç¤ºè¡Œæ•°",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 2,
      "unit": "è¡Œ"
    },
    {
      "type": "header",
      "content": "æ ·å¼è®¾ç½®"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "ä¸»è‰²è°ƒ",
      "default": "#007bff"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "è¾¹æ¡†é¢œè‰²",
      "default": "#e1e1e1"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "èƒŒæ™¯é¢œè‰²",
      "default": "#f8f8f8"
    },
    {
      "type": "header",
      "content": "è¾¹è·è®¾ç½®"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "ä¸Šè¾¹è·",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "ä¸‹è¾¹è·",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "menu_category",
      "name": "èœå•åˆ†ç±»",
      "settings": [
        {
          "type": "text",
          "id": "category_title",
          "label": "åˆ†ç±»æ ‡é¢˜",
          "default": "äº§å“åˆ†ç±»"
        },
        {
          "type": "text",
          "id": "category_description",
          "label": "åˆ†ç±»æè¿°",
          "default": "åˆ†ç±»æè¿°å†…å®¹"
        },
        {
          "type": "header",
          "content": "èœå•å›¾ç‰‡è®¾ç½®"
        },
        {
          "type": "image_picker",
          "id": "category_image",
          "label": "èœå•å›¾ç‰‡"
        },
        {
          "type": "range",
          "id": "image_width",
          "label": "å›¾ç‰‡å®½åº¦",
          "min": 20,
          "max": 100,
          "step": 5,
          "default": 60,
          "unit": "px"
        },
        {
          "type": "range",
          "id": "image_height",
          "label": "å›¾ç‰‡é«˜åº¦",
          "min": 20,
          "max": 100,
          "step": 5,
          "default": 60,
          "unit": "px"
        },
        {
          "type": "header",
          "content": "äº§å“ç³»åˆ—é…ç½®"
        },
        {
          "type": "collection_list",
          "id": "linked_collections",
          "label": "å…³è”äº§å“ç³»åˆ—",
          "limit": 10
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "è‡ªå®šä¹‰èœå•",
      "category": "å¯¼èˆª",
      "blocks": [
        {
          "type": "menu_category",
          "settings": {
            "category_title": "çƒ­é—¨å•†å“",
            "category_description": "æŸ¥çœ‹çƒ­é—¨å•†å“"
          }
        },
        {
          "type": "menu_category",
          "settings": {
            "category_title": "æ–°å“ä¸Šå¸‚",
            "category_description": "æœ€æ–°ä¸Šæ¶å•†å“"
          }
        }
      ]
    }
  ]
}
{% endschema %}

{%- style -%}
  .custom-menu-section-{{ section.id }} {
    display: flex;
    gap: 20px;
    padding: {{ section.settings.padding_top }}px 20px {{ section.settings.padding_bottom }}px;
    min-height: 500px;
    background-color: {{ section.settings.background_color }};
    max-width: 1200px;
    margin: 0 auto;
  }

  .menu-panel-{{ section.id }} {
    width: {{ section.settings.menu_width }}%;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .products-panel-{{ section.id }} {
    width: {{ section.settings.product_width }}%;
    padding: 20px;
    border: 1px solid {{ section.settings.border_color }};
    border-radius: 12px;
    background: white;
    min-height: 400px;
  }

  /* ä¸‹æ‹‰èœå•æ ·å¼ */
  .menu-category-{{ section.id }} {
    position: relative;
    background: white;
    border: 1px solid {{ section.settings.border_color }};
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .menu-category-{{ section.id }}:hover {
    background-color: #f8f8f8;
    border-color: #d0d0d0;
  }

  .menu-category-{{ section.id }}.active {
    background-color: #f0f8ff;
    border-color: {{ section.settings.primary_color }};
  }

  .category-header-{{ section.id }} {
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    gap: 10px;
  }

  .category-header-content {
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-direction: row;
  }
  
  .category-image-{{ section.id }} {
    width: {{ block.settings.image_width }}px;
    height: {{ block.settings.image_height }}px;
    object-fit: cover;
    border-radius: 6px;
    flex-shrink: 0;
    order: -1; /* ç¡®ä¿å›¾ç‰‡æ˜¾ç¤ºåœ¨æœ€å·¦ä¾§ */
  }

  .category-text-content {
    flex: 1;
    min-width: 0;
  }

  .category-header-{{ section.id }} h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
    line-height: 1.3;
    text-align: left;
  }

  .category-header-{{ section.id }} p {
    margin: 4px 0 0 0;
    font-size: 14px;
    color: #666;
    line-height: 1.4;
    display: block;
    text-align: left;
  }

  .dropdown-icon-container {
    flex-shrink: 0;
    margin-top: 4px;
  }

  .dropdown-icon-{{ section.id }} {
    transition: transform 0.3s ease;
    font-size: 12px;
    color: #666;
    display: block;
  }

  .dropdown-icon-{{ section.id }} {
    transition: transform 0.3s ease;
  }

  .menu-category-{{ section.id }}.active .dropdown-icon-{{ section.id }} {
    transform: rotate(180deg);
  }

  .dropdown-content-{{ section.id }} {
    display: none;
    padding: 15px;
    border-top: 1px solid {{ section.settings.border_color }};
    background: white;
  }

  .menu-category-{{ section.id }}.active .dropdown-content-{{ section.id }} {
    display: block;
  }

  .collection-list-{{ section.id }} {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .collection-item-{{ section.id }} {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: color 0.2s ease;
    text-align: center;
  }

  .collection-item-{{ section.id }}:hover {
    color: {{ section.settings.primary_color }};
  }

  .collection-item-{{ section.id }}:last-child {
    border-bottom: none;
  }

  /* äº§å“å±•ç¤ºæ ·å¼ */
  .product-grid-{{ section.id }} {
    display: grid;
    grid-template-columns: repeat({{ section.settings.columns_desktop }}, minmax(0, 1fr));
    gap: 20px;
  }
  
  .product-card-{{ section.id }} {
    border: 1px solid #f0f0f0;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
    background: white;
    list-style: none;
    margin: 0;
  }

  .product-card-{{ section.id }} {
    border: 1px solid #f0f0f0;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
    background: white;
  }

  .product-card-{{ section.id }}:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: {{ section.settings.primary_color }};
  }

  .product-image-{{ section.id }} {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 12px;
  }

  .product-title-{{ section.id }} {
    margin: 0 0 8px 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }

  .product-vendor-{{ section.id }} {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: #666;
  }

  .product-price-{{ section.id }} {
    margin: 0;
    font-size: 18px;
    font-weight: bold;
    color: {{ section.settings.primary_color }};
  }

  .loading-{{ section.id }} {
    text-align: center;
    padding: 60px 20px;
    color: #999;
  }

  .empty-state-{{ section.id }} {
    text-align: center;
    padding: 60px 20px;
    color: #999;
  }

  .empty-state-{{ section.id }} h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
    color: #666;
  }

  .empty-state-{{ section.id }} p {
    margin: 0;
    font-size: 14px;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .custom-menu-section-{{ section.id }} {
      flex-direction: column;
      padding: 20px 15px;
    }

    .menu-panel-{{ section.id }},
    .products-panel-{{ section.id }} {
      width: 100% !important;
    }

    .menu-panel-{{ section.id }} {
      order: 2;
      margin-top: 20px;
    }

    .products-panel-{{ section.id }} {
      order: 1;
      min-height: 300px;
    }

    .product-grid-{{ section.id }} {
      grid-template-columns: repeat({{ section.settings.columns_mobile }}, minmax(0, 1fr));
      gap: 15px;
    }

    .product-image-{{ section.id }} {
      height: 150px;
    }

    .product-title-{{ section.id }} {
      font-size: 14px;
    }

    .product-price-{{ section.id }} {
      font-size: 16px;
    }

    .category-header-{{ section.id }} {
      padding: 12px;
    }

    .dropdown-content-{{ section.id }} {
      padding: 12px;
    }
  }
{%- endstyle -%}

<div class="custom-menu-section-{{ section.id }}">
  <!-- å·¦ä¾§èœå•é¢æ¿ -->
  <div class="menu-panel-{{ section.id }}">
    {% for block in section.blocks %}
      {% if block.type == 'menu_category' %}
        <div class="menu-category-{{ section.id }}" data-category="{{ block.id }}">
          <div class="category-header-{{ section.id }}">
            <div class="category-header-content">
              {% if block.settings.category_image %}
                <img class="category-image-{{ section.id }}" 
                     src="{{ block.settings.category_image | img_url: 'medium' }}" 
                     alt="{{ block.settings.category_title }}"
                     width="{{ block.settings.image_width }}"
                     height="{{ block.settings.image_height }}">
              {% endif %}
              <div class="category-text-content">
                <h3>{{ block.settings.category_title }}</h3>
                <p>{{ block.settings.category_description }}</p>
              </div>
            </div>
            <div class="dropdown-icon-container">
              <span class="dropdown-icon-{{ section.id }}">â–¼</span>
            </div>
          </div>
          
          <div class="dropdown-content-{{ section.id }}">
            {% if block.settings.linked_collections %}
              <ul class="collection-list-{{ section.id }}">
                {% for collection in block.settings.linked_collections %}
                  <li class="collection-item-{{ section.id }}" 
                      data-collection-id="{{ collection.id }}"
                      data-collection-handle="{{ collection.handle }}">
                    {{ collection.title }}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="empty-state-{{ section.id }}">æœªå…³è”ä»»ä½•äº§å“ç³»åˆ—</p>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endfor %}
    
    {% if section.blocks.size == 0 %}
      <div class="empty-state-{{ section.id }}">
        <h3>è¯·æ·»åŠ èœå•åˆ†ç±»</h3>
        <p>åœ¨ä¸»é¢˜ç¼–è¾‘å™¨ä¸­ç‚¹å‡»"æ·»åŠ å†…å®¹"æ¥åˆ›å»ºèœå•åˆ†ç±»</p>
      </div>
    {% endif %}
  </div>
  
  <!-- å³ä¾§äº§å“å±•ç¤ºé¢æ¿ -->
  <div class="products-panel-{{ section.id }}">
    <div class="empty-state-{{ section.id }}">
      <h3>è¯·ç‚¹å‡»å·¦ä¾§èœå•æŸ¥çœ‹äº§å“</h3>
      <p>ç‚¹å‡»èœå•åˆ†ç±»æ˜¾ç¤ºæ‰€æœ‰äº§å“ï¼Œç‚¹å‡»å…·ä½“ç³»åˆ—æ˜¾ç¤ºè¯¥ç³»åˆ—äº§å“</p>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sectionId = '{{ section.id }}';
  const menuCategories = document.querySelectorAll(`.menu-category-${sectionId}`);
  const productsPanel = document.querySelector(`.products-panel-${sectionId}`);
  let allProductsData = null;
  let hoverTimeout = null;

  // åˆå§‹åŒ–èœå•äº¤äº’
  function initMenuInteractions() {
    // èœå•åˆ†ç±»ç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºæ‰€æœ‰ç³»åˆ—äº§å“
    menuCategories.forEach(category => {
      category.addEventListener('click', function() {
        clearTimeout(hoverTimeout);
        loadAllProducts();
        
        // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
        document.querySelectorAll(`.collection-item-${sectionId}`).forEach(i => 
          i.classList.remove('active')
        );
        
        // ç§»é™¤æ‰€æœ‰èœå•åˆ†ç±»çš„æ¿€æ´»çŠ¶æ€
        menuCategories.forEach(cat => cat.classList.remove('active'));
        // è®¾ç½®å½“å‰èœå•åˆ†ç±»ä¸ºæ¿€æ´»çŠ¶æ€
        this.classList.add('active');
      });
    });

    // ç³»åˆ—é¡¹ç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºå•ä¸ªç³»åˆ—äº§å“
    menuCategories.forEach(category => {
      const collectionItems = category.querySelectorAll(`.collection-item-${sectionId}`);
      collectionItems.forEach(item => {
        item.addEventListener('click', function(e) {
          e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ 
          clearTimeout(hoverTimeout);
          const collectionId = this.getAttribute('data-collection-id');
          const collectionHandle = this.getAttribute('data-collection-handle');
          loadSingleCollection(collectionId, collectionHandle);
          
          // è®¾ç½®æ¿€æ´»çŠ¶æ€
          document.querySelectorAll(`.collection-item-${sectionId}`).forEach(i => 
            i.classList.remove('active')
          );
          this.classList.add('active');
          
          // è®¾ç½®çˆ¶èœå•åˆ†ç±»ä¸ºæ¿€æ´»çŠ¶æ€
          menuCategories.forEach(cat => cat.classList.remove('active'));
          category.classList.add('active');
        });
      });
    });

    // é»˜è®¤åŠ è½½æ‰€æœ‰äº§å“
    setTimeout(() => {
      loadAllProducts();
      // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªèœå•åˆ†ç±»
      if (menuCategories.length > 0) {
        menuCategories[0].classList.add('active');
      }
    }, 500);
  }

  // åŠ è½½æ‰€æœ‰ç³»åˆ—çš„äº§å“
  function loadAllProducts() {
    if (allProductsData) {
      displayProducts(allProductsData);
      return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    productsPanel.innerHTML = `
      <div class="loading-${sectionId}">
        <div style="font-size: 24px; margin-bottom: 10px;">â³</div>
        <p>æ­£åœ¨åŠ è½½æ‰€æœ‰äº§å“...</p>
      </div>
    `;

    // æ”¶é›†æ‰€æœ‰ç³»åˆ—çš„äº§å“
    const allCollections = [];
    menuCategories.forEach(category => {
      const collectionItems = category.querySelectorAll(`.collection-item-${sectionId}`);
      collectionItems.forEach(item => {
        const collectionHandle = item.getAttribute('data-collection-handle');
        if (collectionHandle) {
          allCollections.push(collectionHandle);
        }
      });
    });

    if (allCollections.length === 0) {
      showEmptyState();
      return;
    }

    // å¹¶è¡ŒåŠ è½½æ‰€æœ‰ç³»åˆ—çš„äº§å“
    const promises = allCollections.map(handle => 
      fetch(`/collections/${handle}?view=ajax-products`)
        .then(response => response.ok ? response.text() : '')
        .catch(() => '')
    );

    Promise.all(promises)
      .then(results => {
        const combinedHtml = results.filter(html => html.trim()).join('');
        allProductsData = combinedHtml;
        displayProducts(combinedHtml);
      })
      .catch(error => {
        console.error('åŠ è½½æ‰€æœ‰äº§å“é”™è¯¯:', error);
        showErrorState();
      });
  }

  // åŠ è½½å•ä¸ªç³»åˆ—çš„äº§å“
  function loadSingleCollection(collectionId, collectionHandle) {
    if (!collectionHandle) return;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    productsPanel.innerHTML = `
      <div class="loading-${sectionId}">
        <div style="font-size: 24px; margin-bottom: 10px;">â³</div>
        <p>æ­£åœ¨åŠ è½½ç³»åˆ—äº§å“...</p>
      </div>
    `;

    // ä½¿ç”¨Shopify AJAX APIè·å–äº§å“æ•°æ®
    fetch(`/collections/${collectionHandle}?view=ajax-products`)
      .then(response => {
        if (!response.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
        return response.text();
      })
      .then(html => {
        displayProducts(html);
      })
      .catch(error => {
        console.error('åŠ è½½ç³»åˆ—äº§å“é”™è¯¯:', error);
        showErrorState();
      });
  }

  // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
  function showErrorState() {
    productsPanel.innerHTML = `
      <div class="empty-state-${sectionId}">
        <div style="font-size: 24px; margin-bottom: 10px;">âŒ</div>
        <h3>åŠ è½½å¤±è´¥</h3>
        <p>æ— æ³•åŠ è½½äº§å“æ•°æ®ï¼Œè¯·ç¨åé‡è¯•</p>
      </div>
    `;
  }

  // æ˜¾ç¤ºç©ºçŠ¶æ€
  function showEmptyState() {
    productsPanel.innerHTML = `
      <div class="empty-state-${sectionId}">
        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“¦</div>
        <h3>æš‚æ— äº§å“</h3>
        <p>è¯·å…ˆé…ç½®äº§å“ç³»åˆ—</p>
      </div>
    `;
  }

  // æ˜¾ç¤ºäº§å“ - ä¼˜åŒ–ç‰ˆæœ¬
  function displayProducts(html) {
    // è¾“å…¥éªŒè¯å’Œç©ºçŠ¶æ€å¤„ç†
    if (!html || typeof html !== 'string' || html.trim() === '') {
      showEmptyState();
      return;
    }

    try {
      // ä½¿ç”¨æ›´ç°ä»£çš„DOMè§£ææ–¹æ³•
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // æ›´ç²¾ç¡®å’Œé«˜æ•ˆçš„é€‰æ‹©å™¨ - é¿å…é‡å¤åŒ¹é…
      // ä½¿ç”¨å±‚çº§é€‰æ‹©å™¨ç¡®ä¿åªé€‰æ‹©æœ€å¤–å±‚çš„äº§å“å®¹å™¨
      let productCards = [];
      
      // é¦–å…ˆå°è¯•é€‰æ‹©æœ€å¤–å±‚çš„äº§å“å®¹å™¨
      const cardWrappers = doc.querySelectorAll('.card-wrapper:not(.card-wrapper .card-wrapper)');
      if (cardWrappers.length > 0) {
        productCards = Array.from(cardWrappers);
      } else {
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°card-wrapperï¼Œå°è¯•å…¶ä»–é€‰æ‹©å™¨ä½†é¿å…é‡å¤
        const allPossibleCards = doc.querySelectorAll(`
          .product-card:not(.card-wrapper *),
          .grid__item > .card:not(.card-wrapper *),
          [data-product-handle]:not(.card-wrapper *),
          [data-product-id]:not(.card-wrapper *),
          .card:not(.card-wrapper *):not(.product-card *):not([data-product-handle] *):not([data-product-id] *)
        `);
        
        // ä½¿ç”¨æ›´ç®€å•çš„æ–¹æ³•å»é‡ - åŸºäºå…ƒç´ åœ¨DOMä¸­çš„ä½ç½®
        const uniqueCards = [];
        const seenElements = new Set();
        
        Array.from(allPossibleCards).forEach(card => {
          // æ£€æŸ¥è¿™ä¸ªå…ƒç´ æ˜¯å¦å·²ç»æ˜¯å¦ä¸€ä¸ªé€‰ä¸­å…ƒç´ çš„å­å…ƒç´ 
          let isChildOfSelected = false;
          for (const selectedCard of uniqueCards) {
            if (selectedCard.contains(card)) {
              isChildOfSelected = true;
              break;
            }
          }
          
          // æ£€æŸ¥è¿™ä¸ªå…ƒç´ æ˜¯å¦åŒ…å«å…¶ä»–å·²é€‰ä¸­çš„å…ƒç´ 
          let containsSelected = false;
          for (const selectedCard of uniqueCards) {
            if (card.contains(selectedCard) && card !== selectedCard) {
              containsSelected = true;
              // å¦‚æœè¿™ä¸ªå…ƒç´ åŒ…å«å·²é€‰ä¸­çš„å…ƒç´ ï¼Œç§»é™¤å·²é€‰ä¸­çš„å…ƒç´ 
              const index = uniqueCards.indexOf(selectedCard);
              if (index > -1) {
                uniqueCards.splice(index, 1);
              }
              break;
            }
          }
          
          if (!isChildOfSelected && !seenElements.has(card)) {
            uniqueCards.push(card);
            seenElements.add(card);
          }
        });
        
        productCards = uniqueCards;
      }
      
      // æœ€ç»ˆè¿‡æ»¤ï¼šç¡®ä¿æ²¡æœ‰é‡å¤çš„äº§å“
      const finalProductCards = [];
      const productIds = new Set();
      
      productCards.forEach(card => {
        // å°è¯•è·å–äº§å“ID
        const productId = card.getAttribute('data-product-id') || 
                         card.getAttribute('data-product-handle') ||
                         card.querySelector('[data-product-id]')?.getAttribute('data-product-id') ||
                         card.querySelector('[data-product-handle]')?.getAttribute('data-product-handle');
        
        if (!productId || !productIds.has(productId)) {
          if (productId) productIds.add(productId);
          finalProductCards.push(card);
        }
      });
      
      productCards = finalProductCards;
      
      let finalHtml = '';
      
      // å¦‚æœæ‰¾åˆ°äº§å“å¡ç‰‡ï¼Œå¤„ç†å®ƒä»¬
      if (productCards.length > 0) {
        finalHtml = `
          <div class="product-grid-{{ section.id }}">
            ${Array.from(productCards).map((card, index) => {
              // æ ‡å‡†åŒ–äº§å“å¡ç‰‡
              const cleanCard = card.cloneNode(true);
              // æ¸…ç†å†…è”æ ·å¼ä½†ä¿ç•™åŸæœ‰ç±»å
              cleanCard.style.cssText = '';
              // æ·»åŠ æ–°çš„ç±»åè€Œä¸è¦†ç›–åŸæœ‰ç±»å
              cleanCard.classList.add('product-card-{{ section.id }}');
              // ç§»é™¤å¯èƒ½å†²çªçš„å±æ€§
              cleanCard.removeAttribute('id');
              cleanCard.removeAttribute('style');
              // æ·»åŠ æ•°æ®å±æ€§ç”¨äºäº¤äº’
              cleanCard.setAttribute('data-product-index', index);
              // æ·»åŠ åŠ¨ç”»å»¶è¿Ÿ
              cleanCard.style.animationDelay = `${index * 0.1}s`;
              
              return cleanCard.outerHTML;
            }).join('')}
          </div>
        `;
      } else {
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šå¡ç‰‡ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹HTMLä½†ç¡®ä¿æœ‰ç½‘æ ¼å®¹å™¨
        finalHtml = `
          <div class="product-grid-{{ section.id }}">
            ${html}
          </div>
        `;
      }

      // ä½¿ç”¨requestAnimationFrameæé«˜æ€§èƒ½
      requestAnimationFrame(() => {
        productsPanel.innerHTML = finalHtml;
        // æ·»åŠ äº§å“å¡ç‰‡äº¤äº’æ•ˆæœ
        addProductCardInteractions();
      });
      
    } catch (error) {
      console.warn('äº§å“æ˜¾ç¤ºå¤„ç†å¤±è´¥ï¼Œä½¿ç”¨å›é€€æ–¹æ¡ˆ:', error);
      // å›é€€åˆ°åŸå§‹æ–¹æ³•
      fallbackDisplay(html);
    }
  }

  // æ·»åŠ äº§å“å¡ç‰‡äº¤äº’æ•ˆæœ
  function addProductCardInteractions() {
    const cards = productsPanel.querySelectorAll('.product-card-{{ section.id }}');
    
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æé«˜æ€§èƒ½
    cards.forEach(card => {
      card.addEventListener('mouseenter', handleCardHover);
      card.addEventListener('mouseleave', handleCardLeave);
    });
  }

  // å¤„ç†æ‚¬åœæ•ˆæœ
  function handleCardHover(e) {
    const card = e.currentTarget;
    card.style.transform = 'translateY(-4px)';
    card.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
    card.style.transition = 'all 0.3s ease';
  }

  // å¤„ç†ç¦»å¼€æ•ˆæœ
  function handleCardLeave(e) {
    const card = e.currentTarget;
    card.style.transform = 'translateY(0)';
    card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
  }

  // å›é€€æ˜¾ç¤ºæ–¹æ³•
  function fallbackDisplay(html) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    
    const productCards = tempDiv.querySelectorAll('.card, .product-card, .grid__item, .card__inner');
    
    let finalHtml = '';
    
    if (productCards.length > 0) {
      finalHtml = `
        <div class="product-grid-{{ section.id }}">
          ${Array.from(productCards).map(card => {
            const cleanCard = card.cloneNode(true);
            cleanCard.style.cssText = '';
            // ä¿ç•™åŸæœ‰ç±»åï¼Œåªæ·»åŠ æ–°ç±»å
            cleanCard.classList.add('product-card-{{ section.id }}');
            return cleanCard.outerHTML;
          }).join('')}
        </div>
      `;
    } else {
      finalHtml = `
        <div class="product-grid-{{ section.id }}">
          ${html}
        </div>
      `;
    }
    
    productsPanel.innerHTML = finalHtml;
    addProductCardInteractions();
  }

  // åˆå§‹åŒ–
  initMenuInteractions();
});

// æ·»åŠ CSSåŠ¨ç”»
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .product-card-{{ section.id }} {
    animation: fadeIn 0.5s ease forwards;
  }
  
  .product-card-{{ section.id }}:nth-child(1) { animation-delay: 0.1s; }
  .product-card-{{ section.id }}:nth-child(2) { animation-delay: 0.2s; }
  .product-card-{{ section.id }}:nth-child(3) { animation-delay: 0.3s; }
  .product-card-{{ section.id }}:nth-child(4) { animation-delay: 0.4s; }
  .product-card-{{ section.id }}:nth-child(5) { animation-delay: 0.5s; }
  .product-card-{{ section.id }}:nth-child(6) { animation-delay: 0.6s; }
  
  /* æ‚¬åœæ•ˆæœå¢å¼º */
  .collection-item-{{ section.id }}:hover {
    background-color: #f8f8f8;
    transform: translateY(-2px);
    transition: all 0.2s ease;
  }
  
  .collection-item-{{ section.id }}.active {
    background-color: #e3f2fd;
    color: {{ section.settings.primary_color }};
    font-weight: 600;
  }
`;
document.head.appendChild(style);
</script>

{% comment %}
  ä½¿ç”¨è¯´æ˜:
  1. å°†æ­¤æ–‡ä»¶ä¿å­˜ä¸º sections/custom-menu.liquid
  2. åœ¨ä¸»é¢˜ç¼–è¾‘å™¨ä¸­æ·»åŠ æ­¤section
  3. ç‚¹å‡»"æ·»åŠ å†…å®¹"åˆ›å»ºèœå•æŒ‰é’®
  4. ä¸ºæ¯ä¸ªæŒ‰é’®é…ç½®æ ‡é¢˜ã€æè¿°å’Œå…³è”çš„ç³»åˆ—
  5. ä¿å­˜åå³å¯ä½¿ç”¨
{% endcomment %}
